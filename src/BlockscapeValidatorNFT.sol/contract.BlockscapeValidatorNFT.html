<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BlockscapeValidatorNFT</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../src/utils/index.html">❱ utils</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/utils/interfaces/index.html">❱ interfaces</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketMinipool.sol/interface.RocketMinipoolInterface.html">RocketMinipoolInterface</a></li><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketNodeDeposit.sol/interface.RocketNodeDepositInterface.html">RocketNodeDepositInterface</a></li><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketNodeStaking.sol/interface.RocketNodeStakingInterface.html">RocketNodeStakingInterface</a></li><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketStorage.sol/interface.RocketStorageInterface.html">RocketStorageInterface</a></li></ol></li><li class="chapter-item "><a href="../../src/utils/types/index.html">❱ types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/utils/types/MinipoolDeposit.sol/enum.MinipoolDeposit.html">MinipoolDeposit</a></li><li class="chapter-item "><a href="../../src/utils/types/MinipoolDetails.sol/struct.MinipoolDetails.html">MinipoolDetails</a></li><li class="chapter-item "><a href="../../src/utils/types/MinipoolStatus.sol/enum.MinipoolStatus.html">MinipoolStatus</a></li></ol></li><li class="chapter-item "><a href="../../src/utils/BlockscapeAccess.sol/abstract.BlockscapeAccess.html">BlockscapeAccess</a></li><li class="chapter-item "><a href="../../src/utils/BlockscapeErrors.sol/abstract.BlockscapeErrors.html">BlockscapeErrors</a></li><li class="chapter-item "><a href="../../src/utils/BlockscapeEvents.sol/abstract.BlockscapeEvents.html">BlockscapeEvents</a></li><li class="chapter-item "><a href="../../src/utils/BlockscapeShared.sol/abstract.BlockscapeShared.html">BlockscapeShared</a></li></ol></li><li class="chapter-item "><a href="../../src/BlockscapeETHStakeNFT.sol/contract.BlockscapeETHStakeNFT.html">BlockscapeETHStakeNFT</a></li><li class="chapter-item "><a href="../../src/BlockscapeValidatorNFT.sol/error.ValidatorAlreadySet.html">ValidatorAlreadySet</a></li><li class="chapter-item expanded "><a href="../../src/BlockscapeValidatorNFT.sol/contract.BlockscapeValidatorNFT.html" class="active">BlockscapeValidatorNFT</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/BlockscapeNetwork/rocketscape" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="blockscapevalidatornft"><a class="header" href="#blockscapevalidatornft">BlockscapeValidatorNFT</a></h1>
<p><a href="https://github.com/BlockscapeNetwork/rocketscape/blob/c46f2dd75068852009941e7857aca6a55d826b96/src/BlockscapeValidatorNFT.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
ERC1155Supply, ReentrancyGuard, <a href="/src/utils/BlockscapeAccess.sol/abstract.BlockscapeAccess.html">BlockscapeAccess</a>, <a href="/src/utils/BlockscapeShared.sol/abstract.BlockscapeShared.html">BlockscapeShared</a></p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="name"><a class="header" href="#name">name</a></h3>
<p>name constant used for blockexplorers (as to be lower case as per blockexplorer standards)</p>
<pre><code class="language-solidity">string public constant name = &quot;Blockscape Validator NFTs&quot;;
</code></pre>
<h3 id="symbol"><a class="header" href="#symbol">symbol</a></h3>
<p>symbol constant used for blockexplorers (as to be lower case as per blockexplorer standards)</p>
<pre><code class="language-solidity">string public constant symbol = &quot;BSV&quot;;
</code></pre>
<h3 id="curethlimit"><a class="header" href="#curethlimit">curETHlimit</a></h3>
<p>Current Rocketpool Minipool Limit</p>
<pre><code class="language-solidity">uint256 private curETHlimit = 16 ether;
</code></pre>
<h3 id="tokenidtovalidator"><a class="header" href="#tokenidtovalidator">tokenIDtoValidator</a></h3>
<p><em>mapping of tokenID to validator minipool address</em></p>
<pre><code class="language-solidity">mapping(uint256 =&gt; address) private tokenIDtoValidator;
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>each validator related vault gets its separate tokenID which depicts
the nft for each staker</p>
<p><em>the IPNS makes sure the nfts stay reachable via this link while
new nfts get added to the underlying ipfs folder</em></p>
<pre><code class="language-solidity">constructor()
    ERC1155(
        &quot;https://ipfs.blockscape.network/ipns/&quot; &quot;k51qzi5uqu5di5eo5fzr1zypdsz0zct39zpct9s4wesjustul1caeofak3zoej/&quot;
        &quot;{id}.json&quot;
    )
    BlockscapeAccess(msg.sender, BlockscapeShared.blockscapeRocketPoolNode, msg.sender);
</code></pre>
<h3 id="supportsinterface"><a class="header" href="#supportsinterface">supportsInterface</a></h3>
<p><em>needed as the OZ ERC1155 &amp;&amp; AccessControl does both implement the supportsInterface function</em></p>
<pre><code class="language-solidity">function supportsInterface(bytes4 interfaceId) public view virtual override(ERC1155, AccessControl) returns (bool);
</code></pre>
<h3 id="depositvalidatornft"><a class="header" href="#depositvalidatornft">depositValidatorNFT</a></h3>
<p>used by stakers to deposit ETH into the contract</p>
<p><em>the vault must be open and equal the depositing amount</em></p>
<p><em>enought RPL must be staked in the rocketpool by the node</em></p>
<pre><code class="language-solidity">function depositValidatorNFT() external payable;
</code></pre>
<h3 id="withdrawbatch"><a class="header" href="#withdrawbatch">withdrawBatch</a></h3>
<p>this gets triggered by the backend controller when a new token is minted</p>
<p><em>the backend controller is only able to withdraw the current ETH limit</em></p>
<pre><code class="language-solidity">function withdrawBatch() external onlyRole(RP_BACKEND_ROLE) nonReentrant;
</code></pre>
<h3 id="updatevalidator"><a class="header" href="#updatevalidator">updateValidator</a></h3>
<p>update validator address for given token id only once after the NFT has been issued
and the validator was created by the backend
this function will only be called by the backend</p>
<p><em>works only once for a tokenID; it will reopen the vault</em></p>
<p><em>emits no event by design to reduce maintenance costs</em></p>
<pre><code class="language-solidity">function updateValidator(uint256 _tokenID, address _vali) external onlyRole(RP_BACKEND_ROLE);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>Identifier of the NFT</td></tr>
<tr><td><code>_vali</code></td><td><code>address</code></td><td>the current address of the validator</td></tr>
</tbody></table>
<h3 id="preparewithdrawalprocess"><a class="header" href="#preparewithdrawalprocess">prepareWithdrawalProcess</a></h3>
<p>Withdraw is a two step process, first the staker has to call prepareWithdrawalProcess()</p>
<p><em>fist step used by the staker when he or she wants to unstake</em></p>
<pre><code class="language-solidity">function prepareWithdrawalProcess(uint256 _tokenID) external override;
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>which validator NFT the staker wants to unstake; the backend will listen on the event and will unstake the validator. The ETH value with rewards is transparantly available via beacon chain explorers and will be reduced by the withdraw fee, which is fixed to 0.5% after one year.</td></tr>
</tbody></table>
<h3 id="withdrawfunds"><a class="header" href="#withdrawfunds">withdrawFunds</a></h3>
<p>used by the staker after prepareWithdrawalProcess() &amp; the timelock has passed to withdraw the funds</p>
<p><em>the rewards are calculated by the backend controller and are then stored in the contract,
this is needed to be able to calculate the rewards correctly including MEV rewards.</em></p>
<p><em>There off-chain calculated rewards cannot be lower than the on-chain estimated rewards.</em></p>
<pre><code class="language-solidity">function withdrawFunds(uint256 _tokenID) external override;
</code></pre>
<h3 id="calcrewards"><a class="header" href="#calcrewards">calcRewards</a></h3>
<p>this function is called by the backend controller when the UserRequestedWithdrawal is emited</p>
<p><em>the rewards are calculated by the backend controller and are then stored in the contract,
this is needed to be able to calculate the rewards correctly including MEV rewards.
There off-chain calculated rewards cannot be lower than the on-chain estimated rewards.</em></p>
<pre><code class="language-solidity">function calcRewards(uint256 _tokenID, uint256 _calcReward) public onlyRole(RP_BACKEND_ROLE);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>the tokenID of the validator</td></tr>
<tr><td><code>_calcReward</code></td><td><code>uint256</code></td><td>the calculated rewards in wei</td></tr>
</tbody></table>
<h3 id="changeethlimit8"><a class="header" href="#changeethlimit8">changeETHLimit8</a></h3>
<p>the limit might change in the future if rocketpool supports
smaller pool sizes (RPIP-8)</p>
<p><em>this function is only callable by our multisig wallet with ADJ_CONFIG_ROLE</em></p>
<p><em>it will only allow to set the limit to 8 ETH</em></p>
<pre><code class="language-solidity">function changeETHLimit8() external onlyRole(ADJ_CONFIG_ROLE);
</code></pre>
<h3 id="lowerrpcommfee8"><a class="header" href="#lowerrpcommfee8">lowerRPCommFee8</a></h3>
<p><em>this function is only callable by our multisig wallet with ADJ_CONFIG_ROLE</em></p>
<p><em>this will set the comission fee for 8 ETH minipools</em></p>
<pre><code class="language-solidity">function lowerRPCommFee8(uint256 _amount) external onlyRole(ADJ_CONFIG_ROLE);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amount</code></td><td><code>uint256</code></td><td>the new comission</td></tr>
</tbody></table>
<h3 id="getcurrentethlimit"><a class="header" href="#getcurrentethlimit">getCurrentEthLimit</a></h3>
<p>the current depositing threshold</p>
<pre><code class="language-solidity">function getCurrentEthLimit() public view returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>the current ETH limit in wei</td></tr>
</tbody></table>
<h3 id="calcwithdrawfee"><a class="header" href="#calcwithdrawfee">calcWithdrawFee</a></h3>
<p>how much fees would the user has to pay if he or she would unstake now
within the first year of staking the fee is starting at 20% &amp; decreasing linearly, afterwards 0.5%</p>
<pre><code class="language-solidity">function calcWithdrawFee(uint256 _tokenID, address _user) public view override returns (uint256 _amount);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>which NFT the staker wants to unstake</td></tr>
<tr><td><code>_user</code></td><td><code>address</code></td><td></td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amount</code></td><td><code>uint256</code></td><td>how much the user would pay on fees in percent*1e18</td></tr>
</tbody></table>
<h3 id="getvalidatoraddress"><a class="header" href="#getvalidatoraddress">getValidatorAddress</a></h3>
<p>this function is used to get the validator address from the tokenID</p>
<pre><code class="language-solidity">function getValidatorAddress(uint256 _tokenID) public view returns (address);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>the tokenID of the NFT</td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>address</code></td><td>the minipool address of the validator</td></tr>
</tbody></table>
<h3 id="estrewardsnomev"><a class="header" href="#estrewardsnomev">estRewardsNoMEV</a></h3>
<p>this function is a on-chain calculation of the rocketpool ETH rewards.
It does not take MEV into account &amp; will only work correctly
after the Shapella/Shanghai upgrade</p>
<pre><code class="language-solidity">function estRewardsNoMEV(uint256 _tokenID) internal view returns (uint256);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>tokenID of the NFT, the user wants to unstake</td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>rewards in wei minus the withdraw fee</td></tr>
</tbody></table>
<h3 id="totalsupply"><a class="header" href="#totalsupply">totalSupply</a></h3>
<p>total amount of supply</p>
<pre><code class="language-solidity">function totalSupply() external view returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>total amount of ERC-1155 tokens of the contract</td></tr>
</tbody></table>
<h3 id="contracturi"><a class="header" href="#contracturi">contractURI</a></h3>
<p>stake nft metdata location</p>
<p><em>this path will never change as the contract defines a collection</em></p>
<pre><code class="language-solidity">function contractURI() external pure returns (string memory);
</code></pre>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>string</code></td><td>the fixed collection metadata path</td></tr>
</tbody></table>
<h3 id="uri"><a class="header" href="#uri">uri</a></h3>
<p>gets the url to the metadata of a given pool</p>
<pre><code class="language-solidity">function uri(uint256 _tokenID) public pure override returns (string memory);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>the pool</td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>string</code></td><td>the url</td></tr>
</tbody></table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/BlockscapeValidatorNFT.sol/error.ValidatorAlreadySet.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/BlockscapeValidatorNFT.sol/error.ValidatorAlreadySet.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../solidity.min.js"></script>
    </body>
</html>
