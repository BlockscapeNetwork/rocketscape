<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BlockscapeETHStakeNFT</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../src/utils/index.html">❱ utils</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/utils/interfaces/index.html">❱ interfaces</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketMinipool.sol/interface.RocketMinipoolInterface.html">RocketMinipoolInterface</a></li><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketNodeDeposit.sol/interface.RocketNodeDepositInterface.html">RocketNodeDepositInterface</a></li><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketNodeStaking.sol/interface.RocketNodeStakingInterface.html">RocketNodeStakingInterface</a></li><li class="chapter-item "><a href="../../src/utils/interfaces/IRocketStorage.sol/interface.RocketStorageInterface.html">RocketStorageInterface</a></li></ol></li><li class="chapter-item "><a href="../../src/utils/types/index.html">❱ types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/utils/types/MinipoolDeposit.sol/enum.MinipoolDeposit.html">MinipoolDeposit</a></li><li class="chapter-item "><a href="../../src/utils/types/MinipoolDetails.sol/struct.MinipoolDetails.html">MinipoolDetails</a></li><li class="chapter-item "><a href="../../src/utils/types/MinipoolStatus.sol/enum.MinipoolStatus.html">MinipoolStatus</a></li></ol></li><li class="chapter-item "><a href="../../src/utils/BlockscapeAccess.sol/abstract.BlockscapeAccess.html">BlockscapeAccess</a></li><li class="chapter-item "><a href="../../src/utils/BlockscapeErrors.sol/abstract.BlockscapeErrors.html">BlockscapeErrors</a></li><li class="chapter-item "><a href="../../src/utils/BlockscapeEvents.sol/abstract.BlockscapeEvents.html">BlockscapeEvents</a></li><li class="chapter-item "><a href="../../src/utils/BlockscapeShared.sol/abstract.BlockscapeShared.html">BlockscapeShared</a></li></ol></li><li class="chapter-item expanded "><a href="../../src/BlockscapeETHStakeNFT.sol/contract.BlockscapeETHStakeNFT.html" class="active">BlockscapeETHStakeNFT</a></li><li class="chapter-item "><a href="../../src/BlockscapeValidatorNFT.sol/error.ValidatorAlreadySet.html">ValidatorAlreadySet</a></li><li class="chapter-item "><a href="../../src/BlockscapeValidatorNFT.sol/contract.BlockscapeValidatorNFT.html">BlockscapeValidatorNFT</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/BlockscapeNetwork/rocketscape" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="blockscapeethstakenft"><a class="header" href="#blockscapeethstakenft">BlockscapeETHStakeNFT</a></h1>
<p><a href="https://github.com/BlockscapeNetwork/rocketscape/blob/c46f2dd75068852009941e7857aca6a55d826b96/src/BlockscapeETHStakeNFT.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
ERC1155Supply, ReentrancyGuard, <a href="/src/utils/BlockscapeAccess.sol/abstract.BlockscapeAccess.html">BlockscapeAccess</a>, <a href="/src/utils/BlockscapeShared.sol/abstract.BlockscapeShared.html">BlockscapeShared</a></p>
<p><strong>Author:</strong>
Blockscape Finance AG <a href="mailto:info@blockscape.network">info@blockscape.network</a></p>
<p>collects ETH, mints NFT in return for stake, which can be any amount of ETH. The ETH is staked in the blockscape rocketpool infrastructure.</p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="poolsupply"><a class="header" href="#poolsupply">poolSupply</a></h3>
<p>tracks the ETH pool supply</p>
<pre><code class="language-solidity">uint256 private poolSupply;
</code></pre>
<h3 id="name"><a class="header" href="#name">name</a></h3>
<p>constant used for blockexplorers to display the name of the token (as to be lower case as per blockexplorer standards)</p>
<pre><code class="language-solidity">string public constant name = &quot;Blockscape ETH Stake NFTs&quot;;
</code></pre>
<h3 id="symbol"><a class="header" href="#symbol">symbol</a></h3>
<p>constant used for blockexplorers to display the symbol of the token (as to be lower case as per blockexplorer standards)</p>
<pre><code class="language-solidity">string public constant symbol = &quot;BSS&quot;;
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>each pool related vault gets its separate tokenID which depicts
the nft for each staker</p>
<p><em>the IPNS makes sure the nfts stay reachable via this link while
new nfts get added to the underlying ipfs folder</em></p>
<pre><code class="language-solidity">constructor()
    ERC1155(&quot;https://ipfs.blockscape.network/ipns/&quot; &quot;TBD/&quot; &quot;{id}.json&quot;)
    BlockscapeAccess(msg.sender, BlockscapeShared.blockscapeRocketPoolNode, msg.sender);
</code></pre>
<h3 id="supportsinterface"><a class="header" href="#supportsinterface">supportsInterface</a></h3>
<p><em>needed as the OZ ERC1155 &amp;&amp; AccessControl does both implement the supportsInterface function</em></p>
<pre><code class="language-solidity">function supportsInterface(bytes4 interfaceId) public view virtual override(ERC1155, AccessControl) returns (bool);
</code></pre>
<h3 id="depositstakenft"><a class="header" href="#depositstakenft">depositStakeNFT</a></h3>
<p>used by stakers to deposit ETH into the contract</p>
<p><em>the vault must be open and enough RPL must be staked in the rocketpool by the node</em></p>
<p><em>the msg.value must be greater than 0</em></p>
<p><em>the msg.value is added to the poolSupply</em></p>
<p><em>if contract balance is greater than 8 ETH, the ETH is sent to the rocketpool node</em></p>
<pre><code class="language-solidity">function depositStakeNFT() external payable nonReentrant;
</code></pre>
<h3 id="updatestake"><a class="header" href="#updatestake">updateStake</a></h3>
<p>update the stake of the given tokenID, if the NFT owner decides to stake more ETH</p>
<p><em>emits the StakeUpdated event &amp; increases the poolSupply based on the msg.value</em></p>
<pre><code class="language-solidity">function updateStake(uint256 _tokenID) external payable;
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>Identifier of the vault</td></tr>
</tbody></table>
<h3 id="preparewithdrawalprocess"><a class="header" href="#preparewithdrawalprocess">prepareWithdrawalProcess</a></h3>
<p>Withdraw is a two step process, first the staker has to call prepareWithdrawalProcess()</p>
<p><em>first step used by the staker when he or she wants to unstake</em></p>
<pre><code class="language-solidity">function prepareWithdrawalProcess(uint256 _tokenID) external override;
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>which ETH Stake NFT the staker wants to unstake the backend will listen on the event and will unstake the validator. The ETH value with rewards is transparantly available via beacon chain explorers and will be reduced by the withdraw fee, which is fixed to 0.5% after one year.</td></tr>
</tbody></table>
<h3 id="withdrawfunds"><a class="header" href="#withdrawfunds">withdrawFunds</a></h3>
<p>used by the staker after prepareWithdrawalProcess() &amp; the timelock has passed to withdraw the funds</p>
<p><em>the rewards are calculated by the backend controller and are then stored in the contract,
this is needed to be able to calculate the rewards correctly including MEV rewards.
There off-chain calculated rewards cannot be lower than the on-chain esimated rewards.</em></p>
<pre><code class="language-solidity">function withdrawFunds(uint256 _tokenID) external override nonReentrant;
</code></pre>
<h3 id="getpoolsupply"><a class="header" href="#getpoolsupply">getPoolSupply</a></h3>
<p>returns the current ETH supply of the pool</p>
<pre><code class="language-solidity">function getPoolSupply() public view returns (uint256);
</code></pre>
<h3 id="calcwithdrawfee"><a class="header" href="#calcwithdrawfee">calcWithdrawFee</a></h3>
<p>how much fees would the user have to pay if he or she would to unstake now
within the first year of staking the fee is starting at 20% &amp; decreasing linearly, afterwards 0.5%</p>
<pre><code class="language-solidity">function calcWithdrawFee(uint256 _tokenID, address _user) public view override returns (uint256 _amount);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>which NFT the staker wants to unstake</td></tr>
<tr><td><code>_user</code></td><td><code>address</code></td><td></td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amount</code></td><td><code>uint256</code></td><td>how much the user would pay on fees in percent*1e18</td></tr>
</tbody></table>
<h3 id="calcapr"><a class="header" href="#calcapr">calcApr</a></h3>
<p>this function is a on-chain calculation of the rocketpool ETH rewards.</p>
<p>It does take MEV (estimated) into account.</p>
<p><em>exp(((31556926 / 384) * 64) / 31622 / sqrt(balanceStaked)) - 1) * 100 - 0.5</em></p>
<p><em>31556926 = seconds per year</em></p>
<p><em>384 = seconds per epoch</em></p>
<p><em>31556926 / 384 = epochs per year</em></p>
<p><em>64 = BASE_REWARD_FACTOR</em></p>
<p><em>31622 = sqrt(gwei per ETH)</em></p>
<p><em>166.32368815e18 = ((31556926 / 384) * 64) / 31622</em></p>
<p><em>0x00000000219ab540356cBB839Cbe05303d7705Fa = deposit contract address</em></p>
<pre><code class="language-solidity">function calcApr() internal view returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>rewards annual procentage rate * 1e18</td></tr>
</tbody></table>
<h3 id="calcrewards"><a class="header" href="#calcrewards">calcRewards</a></h3>
<p>calculates the rewards for the staker based on the current APR and the time staked</p>
<pre><code class="language-solidity">function calcRewards(uint256 _tokenID) internal view returns (uint256);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>which the rewards are calculated for</td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>ETH rewards in wei minus the withdraw fee</td></tr>
</tbody></table>
<h3 id="totalsupply"><a class="header" href="#totalsupply">totalSupply</a></h3>
<p>how many NFTs are there totally</p>
<pre><code class="language-solidity">function totalSupply() external view returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>total amount of NFTs minted</td></tr>
</tbody></table>
<h3 id="contracturi"><a class="header" href="#contracturi">contractURI</a></h3>
<p>stake nft metdata location</p>
<p><em>this path will never change as the contract defines a collection</em></p>
<pre><code class="language-solidity">function contractURI() external pure returns (string memory);
</code></pre>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>string</code></td><td>the fixed collection metadata path</td></tr>
</tbody></table>
<h3 id="uri"><a class="header" href="#uri">uri</a></h3>
<p>gets the url to the metadata of a given NFT tokenID</p>
<pre><code class="language-solidity">function uri(uint256 _tokenID) public pure override returns (string memory);
</code></pre>
<p><strong>Parameters</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenID</code></td><td><code>uint256</code></td><td>the pool</td></tr>
</tbody></table>
<p><strong>Returns</strong></p>
<table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>string</code></td><td>the NFT metadata url</td></tr>
</tbody></table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/utils/BlockscapeShared.sol/abstract.BlockscapeShared.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../src/BlockscapeValidatorNFT.sol/error.ValidatorAlreadySet.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/utils/BlockscapeShared.sol/abstract.BlockscapeShared.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../src/BlockscapeValidatorNFT.sol/error.ValidatorAlreadySet.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../solidity.min.js"></script>
    </body>
</html>
